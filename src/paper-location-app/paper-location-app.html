<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">

<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/app-layout/app-layout.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="../map/map-component.html">

<dom-module id="paper-location-app">
    <template>
        <style>
            .places {
                display: flex;
                flex-direction: column;
            }

            .menu {
                height: 100%;
                overflow-y: scroll;
            }

            .collapse-content {
                padding: 15px;
                border: 1px solid #dedede;
            }

            paper-button {
                font-size: 0.7rem;
            }

            paper-item {
                font-size: 0.7rem;
            }
        </style>
        <iron-ajax
                auto
                url="places.json"
                handle-as="json"
                on-response="handleResponse"
                debounce-duration="300"></iron-ajax>
        <app-drawer-layout fullbleed narrow="{{narrow}}">
            <app-drawer id="drawer" slot="drawer" swipe-open="[[narrow]]">
                <div class="menu">
                    <paper-input label="Buscar un lugar" type="search" id="query">
                        <paper-icon-button slot="suffix" icon="search" on-tap="search"></paper-icon-button>
                    </paper-input>
                    <paper-button on-tap="showPlaces">Áreas administrativas</paper-button>
                    <paper-button on-tap="showPlaces">Áreas de apoyo</paper-button>
                    <hr>
                    <template is="dom-if" if="[[isSearching]]">
                        <template is="dom-repeat" items="[[places]]" as="place" filter="isSearch">
                            <div class="places">
                                <paper-button on-tap="pin">
                                    <paper-item>
                                        [[place.label]]
                                    </paper-item>
                                </paper-button>
                            </div>
                        </template>
                    </template>
                    <iron-collapse id="collapse">
                        <div class="collapse-content">
                            <template is="dom-if" if="[[isAdminAreaSelected]]">
                                <template is="dom-repeat" items="[[places]]" as="place" filter="isAdmin">
                                    <div class="places">
                                        <paper-button on-tap="pin">
                                            <paper-item>
                                                [[place.label]]
                                            </paper-item>
                                        </paper-button>
                                    </div>
                                </template>
                            </template>
                            <template is="dom-if" if="[[isHelperAreaSelected]]">
                                <template is="dom-repeat" items="[[places]]" as="place" filter="isHelper">
                                    <div class="places">
                                        <paper-button on-tap="pin">
                                            <paper-item>
                                                [[place.label]]
                                            </paper-item>
                                        </paper-button>
                                    </div>
                                </template>
                            </template>
                        </div>
                    </iron-collapse>
                </div>
            </app-drawer>
            <app-header-layout>
                <app-header slot="header">
                    <app-toolbar>
                        <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
                        <div main-title>UAA Localización</div>
                    </app-toolbar>
                </app-header>
                <map-component market="[[market]]"></map-component>
                <!--TODO add current location-->
            </app-header-layout>
        </app-drawer-layout>
    </template>

    <script>
        'use strict';
        (function AppDefinition(customElements) {
            /**
             * @customElement
             * @polymer
             */
            class PaperLocationApp extends Polymer.GestureEventListeners(Polymer.Element) {
                static get is() {
                    return 'paper-location-app';
                }

                static get properties() {
                    return {
                        places: {
                            type: Array,
                            value: []
                        },
                        isAdminAreaSelected: {
                            type: Boolean,
                            value: false
                        },
                        isHelperAreaSelected: {
                            type: Boolean,
                            value: false
                        },
                        isSearching: {
                            type: Boolean,
                            value: false
                        },
                        market: {
                            type: Object,
                            value: {}
                        }
                    };
                }

                showPlaces(event) {
                    switch (event.path[0].innerText) {
                        case 'ÁREAS ADMINISTRATIVAS':
                            this.set('isAdminAreaSelected', true);
                            this.set('isHelperAreaSelected', false);
                            break;
                        case 'ÁREAS DE APOYO':
                            this.set('isHelperAreaSelected', true);
                            this.set('isAdminAreaSelected', false);
                            break;
                    }
                    this.$.collapse.toggle();
                }

                pin(event) {
                    this.set('market', event.model.__data.place.position);
                }

                isAdmin(place) {
                    return place.category == 'ÁREAS ADMINISTRATIVAS';
                }

                isHelper(place) {
                    return place.category == 'ÁREAS DE APOYO';
                }

                isSearch(place) {
                    return place.label.toLowerCase().includes(this.$.query.value.toLowerCase());
                }

                search() {
                    if (this.$.query.value !== '') {
                        this.set('isSearching', true);
                    } else {
                        this.set('isSearching', false);
                        this.$.query.value = '';
                    }
                }

                handleResponse(event) {
                    this.set('places', event.detail.__data.response);
                }
            }

            customElements.define(PaperLocationApp.is, PaperLocationApp);
        })(window.customElements);
    </script>
</dom-module>
